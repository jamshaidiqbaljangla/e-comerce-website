class AdminAuth{constructor(){this.API_BASE='/api';this.setupAuthInterceptor();this.setupRefreshTokenTimer();this.setupCSRFProtection();}init(){const token=this.getToken();const user=this.getUser();if(!token||!user||user.role!=='admin'){this.redirectToLogin();return false;}if(window.location.pathname.endsWith('admin-login.html')){window.location.href='admin.html';return false;}return true;}setupCSRFProtection(){const csrfToken=document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');if(csrfToken){this.csrfToken=csrfToken;}}setupAuthInterceptor(){const originalFetch=window.fetch;window.fetch=async(url,options={})=>{const newOptions={...options};if(!newOptions.headers){newOptions.headers={};}const token=this.getToken();if(token){newOptions.headers['Authorization']=`Bearer ${token}`;}if(this.csrfToken){newOptions.headers['X-CSRF-Token']=this.csrfToken;}try{const response=await originalFetch(url,newOptions);if(response.status===401){const refreshed=await this.refreshToken();if(refreshed){newOptions.headers['Authorization']=`Bearer ${this.getToken()}`;return originalFetch(url,newOptions);}else{this.logout();throw new Error('Authentication failed');}}return response;}catch(error){if(error.message==='Network Error'){this.showError('Network connection lost. Please check your internet connection.');}throw error;}};}setupRefreshTokenTimer(){setInterval(async()=>{const token=this.getToken();if(token){const payload=this.parseJWT(token);const expiryTime=payload.exp*1000;const currentTime=Date.now();const fiveMinutes=5*60*1000;if(expiryTime-currentTime<fiveMinutes){await this.refreshToken();}}},60000);}parseJWT(token){try{return JSON.parse(atob(token.split('.')[1]));}catch(e){return null;}}getToken(){return localStorage.getItem('adminAuthToken');}getUser(){try{return JSON.parse(localStorage.getItem('adminUser'));}catch{return null;}}async refreshToken(){try{const refreshToken=localStorage.getItem('adminRefreshToken');if(!refreshToken)return false;const response=await fetch(`${this.API_BASE}/auth/refresh`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({refreshToken})});if(!response.ok)return false;const data=await response.json();localStorage.setItem('adminAuthToken',data.token);localStorage.setItem('adminRefreshToken',data.refreshToken);return true;}catch{return false;}}logout(){localStorage.removeItem('adminAuthToken');localStorage.removeItem('adminRefreshToken');localStorage.removeItem('adminUser');this.redirectToLogin();}redirectToLogin(){if(!window.location.pathname.endsWith('admin-login.html')){window.location.href='admin-login.html';}}showError(message){const event=new CustomEvent('admin-error',{detail:message});window.dispatchEvent(event);}}const adminAuth=new AdminAuth();if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>adminAuth.init());}else{adminAuth.init();}