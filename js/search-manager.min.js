window.SearchManager={config:{minSearchLength:2,maxSuggestions:6,maxRecentSearches:5,searchDelay:300,dropdownOpenClass:'active'},state:{searchTerm:'',recentSearches:[],searchResults:[],resultCount:0,searching:false,searchTimeout:null,sortOrder:'relevance'},init:function(){console.log('[DEBUG]search-manager.js:Search Manager initializing...');this.loadRecentSearches();this.setupSearchListeners();this.initSortingControls();if(window.location.pathname.includes('search.html')){this.handleSearchResultsPage();}console.log('[DEBUG]search-manager.js:Search Manager initialized');},setupSearchListeners:function(){const searchForms=document.querySelectorAll('.search-form');searchForms.forEach(form=>{form.addEventListener('submit',(e)=>{e.preventDefault();const input=form.querySelector('input[type="text"]');if(input&&input.value.trim().length>=this.config.minSearchLength){this.performSearch(input.value.trim());}});const searchInput=form.querySelector('input[type="text"]');if(searchInput){searchInput.addEventListener('input',(e)=>{const searchTerm=e.target.value.trim();this.state.searchTerm=searchTerm;const clearBtn=form.querySelector('.clear-search');if(clearBtn){clearBtn.style.display=searchTerm.length>0?'block':'none';}if(this.state.searchTimeout){clearTimeout(this.state.searchTimeout);}if(searchTerm.length<this.config.minSearchLength){this.clearSearchSuggestions();return;}this.state.searchTimeout=setTimeout(()=>{this.showSearchSuggestions(searchTerm);},this.config.searchDelay);});searchInput.addEventListener('focus',()=>{if(searchInput.value.trim().length<this.config.minSearchLength){this.showRecentSearches();}});searchInput.addEventListener('keydown',(e)=>{if(e.key==='Escape'){this.clearSearchSuggestions();searchInput.blur();this.closeSearchDropdown();}});}const clearBtn=form.querySelector('.clear-search');if(clearBtn){clearBtn.style.display='none';clearBtn.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();const searchInput=form.querySelector('input[type="text"]');if(searchInput){searchInput.value='';searchInput.focus();clearBtn.style.display='none';this.showRecentSearches();}});}});const searchToggles=document.querySelectorAll('.search-toggle');searchToggles.forEach(toggle=>{toggle.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();const searchContainer=toggle.closest('.search-container');if(searchContainer){const isActive=searchContainer.classList.contains(this.config.dropdownOpenClass);document.querySelectorAll('.search-container').forEach(container=>{container.classList.remove(this.config.dropdownOpenClass);});if(!isActive){searchContainer.classList.add(this.config.dropdownOpenClass);const searchInput=searchContainer.querySelector('input[type="text"]');if(searchInput){setTimeout(()=>{searchInput.focus();if(searchInput.value.trim().length<this.config.minSearchLength){this.showRecentSearches();}},100);}}}});});document.addEventListener('click',(e)=>{if(!e.target.closest('.search-container')){this.closeSearchDropdown();}});},closeSearchDropdown:function(){const searchContainers=document.querySelectorAll('.search-container');searchContainers.forEach(container=>{container.classList.remove(this.config.dropdownOpenClass);});},initSortingControls:function(){const sortSelect=document.getElementById('search-sort');if(sortSelect){sortSelect.addEventListener('change',()=>{this.state.sortOrder=sortSelect.value;const searchTerm=new URLSearchParams(window.location.search).get('q');if(searchTerm&&this.state.searchResults.length>0){this.sortSearchResults();this.displaySearchResults(searchTerm,false);}});}},sortSearchResults:function(){switch(this.state.sortOrder){case 'price-low':this.state.searchResults.sort((a,b)=>a.price-b.price);break;case 'price-high':this.state.searchResults.sort((a,b)=>b.price-a.price);break;case 'newest':this.state.searchResults.sort((a,b)=>{const dateA=a.dateAdded?new Date(a.dateAdded):a.id;const dateB=b.dateAdded?new Date(b.dateAdded):b.id;return dateB-dateA;});break;case 'relevance':default:this.state.searchResults.sort((a,b)=>b.relevanceScore-a.relevanceScore);break;}},showSearchSuggestions:function(searchTerm){if(!searchTerm||searchTerm.length<this.config.minSearchLength){return;}this.state.searching=true;const searchResults=this.searchProducts(searchTerm);const suggestionContainers=document.querySelectorAll('.search-suggestions');if(suggestionContainers.length===0)return;suggestionContainers.forEach(container=>{container.innerHTML='<div class="searching"><div class="spinner"></div><p>Searching...</p></div>';container.style.display='block';setTimeout(()=>{if(this.state.searchTerm!==searchTerm)return;if(searchResults.length>0){const limitedResults=searchResults.slice(0,this.config.maxSuggestions);let suggestionsHtml=`<div class="suggestions-header"><h4>Suggestions</h4><a href="search.html?q=${encodeURIComponent(searchTerm)}" class="view-all">View all results</a></div><div class="suggestions-items">`;limitedResults.forEach(product=>{suggestionsHtml+=`<a href="product.html?id=${product.id}" class="suggestion-item"><div class="suggestion-image"><img src="${product.images.primary}" alt="${product.name}"></div><div class="suggestion-content"><h4>${this.highlightSearchTerm(product.name,searchTerm)}</h4><div class="suggestion-price">${this.formatPrice(product.price)}</div></div></a>`;});suggestionsHtml+=`</div><div class="suggestions-footer"><a href="search.html?q=${encodeURIComponent(searchTerm)}" class="btn btn-dark btn-sm">View all ${searchResults.length}results</a></div>`;container.innerHTML=suggestionsHtml;}else{container.innerHTML=`<div class="no-suggestions"><p>No results found for "${searchTerm}"</p><a href="shop.html" class="btn btn-outline btn-sm">Browse all products</a></div>`;}this.state.searching=false;},300);});},showRecentSearches:function(){const suggestionContainers=document.querySelectorAll('.search-suggestions');if(suggestionContainers.length===0)return;const recentSearches=this.state.recentSearches;suggestionContainers.forEach(container=>{if(recentSearches.length>0){let recentHtml=`<div class="suggestions-header"><h4>Recent Searches</h4><button class="clear-recent">Clear</button></div><div class="recent-searches">`;recentSearches.forEach(search=>{recentHtml+=`<a href="search.html?q=${encodeURIComponent(search)}" class="recent-search-item"><i class="fas fa-history"></i><span>${search}</span></a>`;});recentHtml+=`</div><div class="suggestions-footer"><a href="shop.html" class="btn btn-outline btn-sm">Browse all products</a></div>`;container.innerHTML=recentHtml;container.style.display='block';const clearBtn=container.querySelector('.clear-recent');if(clearBtn){clearBtn.addEventListener('click',(e)=>{e.stopPropagation();this.clearRecentSearches();this.showRecentSearches();});}}else{container.innerHTML=`<div class="no-suggestions"><p>Start typing to search products</p><a href="shop.html" class="btn btn-outline btn-sm">Browse all products</a></div>`;container.style.display='block';}});},clearSearchSuggestions:function(){const suggestionContainers=document.querySelectorAll('.search-suggestions');suggestionContainers.forEach(container=>{container.innerHTML='';container.style.display='none';});},performSearch:function(searchTerm){if(!searchTerm||searchTerm.length<this.config.minSearchLength){return;}this.addToRecentSearches(searchTerm);if(window.location.pathname.includes('search.html')){const url=new URL(window.location);url.searchParams.set('q',searchTerm);window.history.pushState({},'',url);document.title=`Search:${searchTerm}|BINGO`;const searchHeading=document.getElementById('search-heading');if(searchHeading){searchHeading.textContent=`Search Results for "${searchTerm}"`;}this.displaySearchResults(searchTerm,true);return;}window.location.href=`search.html?q=${encodeURIComponent(searchTerm)}`;},handleSearchResultsPage:function(){const urlParams=new URLSearchParams(window.location.search);const searchTerm=urlParams.get('q');if(!searchTerm||searchTerm.length<this.config.minSearchLength){window.location.href='shop.html';return;}document.querySelectorAll('.search-form input[type="text"]').forEach(input=>{input.value=searchTerm;const clearBtn=input.parentElement.querySelector('.clear-search');if(clearBtn){clearBtn.style.display='block';}});document.title=`Search:${searchTerm}|BINGO`;const searchHeading=document.getElementById('search-heading');if(searchHeading){searchHeading.textContent=`Search Results for "${searchTerm}"`;}this.addToRecentSearches(searchTerm);this.displaySearchResults(searchTerm,true);const sortOrder=urlParams.get('sort');if(sortOrder){this.state.sortOrder=sortOrder;const sortSelect=document.getElementById('search-sort');if(sortSelect){sortSelect.value=sortOrder;}}},displaySearchResults:function(searchTerm,performNewSearch=true){const resultsContainer=document.getElementById('search-results');if(!resultsContainer)return;if(performNewSearch){resultsContainer.innerHTML=`<div class="searching"><div class="spinner"></div><p>Searching for "${searchTerm}"...</p></div>`;this.state.searchResults=this.searchProducts(searchTerm);}this.sortSearchResults();this.state.resultCount=this.state.searchResults.length;const resultCount=document.getElementById('result-count');if(resultCount){resultCount.textContent=this.state.resultCount;}setTimeout(()=>{if(this.state.searchResults.length>0){let resultsHtml='';this.state.searchResults.forEach(product=>{resultsHtml+=`<div class="search-result-item" data-product-id="${product.id}"><div class="result-image"><a href="product.html?id=${product.id}"><img src="${product.images.primary}" alt="${product.name}"></a></div><div class="result-content"><h3 class="result-title"><a href="product.html?id=${product.id}">${this.highlightSearchTerm(product.name,searchTerm)}</a></h3><div class="result-category">${this.getCategoryLinks(product.categories)}</div><div class="result-description">${this.highlightSearchTerm(this.truncateText(product.description||'',150),searchTerm)}</div><div class="result-price">${product.oldPrice?`<span class="old-price">${this.formatPrice(product.oldPrice)}</span>`:''}<span class="current-price">${this.formatPrice(product.price)}</span></div><div class="result-actions"><button class="btn btn-dark add-to-cart-btn" data-product-id="${product.id}" ${!product.inStock?'disabled':''}>${product.inStock?'Add to Cart':'Sold Out'}</button><button class="btn btn-outline wishlist-btn" data-product-id="${product.id}"><i class="far fa-heart"></i>Wishlist</button></div></div></div>`;});resultsContainer.innerHTML=resultsHtml;this.generateRelatedSearches(searchTerm);if(window.CartManager&&typeof window.CartManager.bindEvents==='function'){window.CartManager.bindEvents();}if(window.WishlistManager&&typeof window.WishlistManager.updateWishlistDisplay==='function'){window.WishlistManager.updateWishlistDisplay();}}else{resultsContainer.innerHTML=`<div class="no-results"><i class="fas fa-search"></i><h3>No results found for "${searchTerm}"</h3><p>Try different keywords or browse all our products.</p><a href="shop.html" class="btn btn-dark">Browse All Products</a></div>`;const relatedContainer=document.getElementById('related-searches');if(relatedContainer){relatedContainer.style.display='none';}}},performNewSearch?500:0);},generateRelatedSearches:function(searchTerm){const relatedContainer=document.getElementById('related-searches');if(!relatedContainer)return;if(this.state.searchResults.length===0||searchTerm.length<3){relatedContainer.style.display='none';return;}const categories=new Set();const keywords=new Set();const termWords=searchTerm.toLowerCase().split(/\s+/);this.state.searchResults.forEach(product=>{if(product.categories&&product.categories.length){product.categories.forEach(catId=>{if(window.PRODUCTS&&window.PRODUCTS.categories&&window.PRODUCTS.categories[catId]){categories.add(window.PRODUCTS.categories[catId].name);}});}if(product.name){const nameWords=product.name.toLowerCase().split(/\s+/);nameWords.forEach(word=>{if(word.length>3&&!termWords.includes(word)){keywords.add(word.charAt(0).toUpperCase()+word.slice(1));}});}});const relatedSearches=[];categories.forEach(category=>{relatedSearches.push(`${searchTerm}in ${category}`);});keywords.forEach(keyword=>{relatedSearches.push(`${searchTerm}${keyword}`);});if(relatedSearches.length>0){const limitedRelated=relatedSearches.slice(0,8);let relatedHtml='';limitedRelated.forEach(related=>{relatedHtml+=`<a href="search.html?q=${encodeURIComponent(related)}" class="related-search-tag">${related}</a>`;});const relatedSearchesDiv=relatedContainer.querySelector('.related-searches');if(relatedSearchesDiv){relatedSearchesDiv.innerHTML=relatedHtml;relatedContainer.style.display='block';}}else{relatedContainer.style.display='none';}},searchProducts:function(searchTerm){const normalizedTerm=searchTerm.toLowerCase().trim();const searchTerms=normalizedTerm.split(/\s+/);if(!window.PRODUCTS||!Array.isArray(window.PRODUCTS.items)){console.error('[DEBUG]search-manager.js:PRODUCTS data not available for search.');return[];}return window.PRODUCTS.items .map(product=>{const name=product.name.toLowerCase();const description=(product.description||'').toLowerCase();const categoryNames=(product.categories||[]).map(cat=>{return window.PRODUCTS.categories&&window.PRODUCTS.categories[cat]?window.PRODUCTS.categories[cat].name.toLowerCase():cat.toLowerCase();});let relevanceScore=0;let allTermsMatch=true;searchTerms.forEach(term=>{let termMatches=false;if(name.includes(term)){relevanceScore+=10;termMatches=true;if(name===term||name.startsWith(term+' ')){relevanceScore+=15;}}if(description.includes(term)){relevanceScore+=5;termMatches=true;}if(categoryNames.some(cat=>cat.includes(term))){relevanceScore+=7;termMatches=true;}if(!termMatches){allTermsMatch=false;}});if(searchTerms.length>1&&!allTermsMatch){relevanceScore=0;}return{...product,relevanceScore};}).filter(product=>product.relevanceScore>0).sort((a,b)=>b.relevanceScore-a.relevanceScore);},highlightSearchTerm:function(text,searchTerm){if(!text||!searchTerm)return text;const normalizedSearchTerm=searchTerm.toLowerCase().trim();const searchTerms=normalizedSearchTerm.split(/\s+/);const searchRegex=new RegExp(`(${searchTerms.join('|')})`,'gi');return text.replace(searchRegex,'<span class="highlight">$1</span>');},getCategoryLinks:function(categories){if(!categories||!Array.isArray(categories)||categories.length===0){return '';}return categories.map(categoryId=>{const categoryName=window.PRODUCTS&&window.PRODUCTS.categories&&window.PRODUCTS.categories[categoryId]?window.PRODUCTS.categories[categoryId].name:this.formatCategoryName(categoryId);return `<a href="category.html?id=${categoryId}" class="result-category-link">${categoryName}</a>`;}).join(',');},formatCategoryName:function(category){return category .split('-').map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(' ');},formatPrice:function(price){if(typeof price!=='number'){return '$0.00';}return `$${price.toFixed(2)}`;},truncateText:function(text,maxLength){if(!text||text.length<=maxLength){return text;}const breakPoint=text.lastIndexOf(' ',maxLength);if(breakPoint===-1){return text.substring(0,maxLength)+'...';}return text.substring(0,breakPoint)+'...';},addToRecentSearches:function(searchTerm){if(!searchTerm||searchTerm.length<this.config.minSearchLength){return;}const normalizedTerm=searchTerm.trim();const recentSearches=this.state.recentSearches.filter(term=>term!==normalizedTerm);recentSearches.unshift(normalizedTerm);this.state.recentSearches=recentSearches.slice(0,this.config.maxRecentSearches);this.saveRecentSearches();},clearRecentSearches:function(){this.state.recentSearches=[];this.saveRecentSearches();},saveRecentSearches:function(){try{localStorage.setItem('bingoRecentSearches',JSON.stringify(this.state.recentSearches));}catch(e){console.error('[DEBUG]search-manager.js:Error saving recent searches:',e);}},loadRecentSearches:function(){try{const savedSearches=localStorage.getItem('bingoRecentSearches');if(savedSearches){this.state.recentSearches=JSON.parse(savedSearches);}}catch(e){console.error('[DEBUG]search-manager.js:Error loading recent searches:',e);this.state.recentSearches=[];}}};if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){if(window.SearchManager){window.SearchManager.init();}});}else{if(window.SearchManager){window.SearchManager.init();}}console.log('[DEBUG]search-manager.js:SearchManager object defined');