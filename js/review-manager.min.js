window.ReviewManager={config:{defaultPageSize:5,mediaUploadLimit:5,maxReviewLength:2000,minReviewLength:10,sortOptions:['newest','highest','lowest','most-helpful','with-media'],filterOptions:['all','5','4','3','2','1','with-media','verified']},state:{currentProductId:null,currentReviews:[],userReviews:{},reviewVotes:{},sortBy:'newest',filterBy:'all',currentPage:1,reviewFormVisible:false,reviewDraft:{rating:0,title:'',content:'',media:[]},reviewStats:{averageRating:0,totalCount:0,distribution:{5:0,4:0,3:0,2:0,1:0}}},init:function(){console.log('[DEBUG]review-manager.js:Review Manager initializing...');if(this.isProductPage()){this.initProductPageReviews();}if(window.location.pathname.includes('account')&&window.location.hash==='#reviews'){this.initUserReviewsPage();}this.loadUserReviewData();this.bindGlobalEvents();console.log('[DEBUG]review-manager.js:Review Manager initialized');},initProductPageReviews:function(){console.log('[DEBUG]review-manager.js:Initializing product page reviews');const productDetailSection=document.querySelector('.product-detail');if(!productDetailSection){console.warn('[DEBUG]review-manager.js:Product detail section not found');return;}const productId=productDetailSection.getAttribute('data-product-id');if(!productId){console.warn('[DEBUG]review-manager.js:Product ID not found');return;}this.state.currentProductId=productId;this.setupReviewListeners();this.loadProductReviews(productId);if(window.location.hash==='#reviews'){const reviewsTab=document.getElementById('reviews-tab');if(reviewsTab){reviewsTab.click();}}},initUserReviewsPage:function(){console.log('[DEBUG]review-manager.js:Initializing user reviews page');this.loadUserReviews();this.setupUserReviewsPageListeners();},bindGlobalEvents:function(){document.addEventListener('userAuthenticated',()=>{this.updateReviewFormAccess();this.checkPendingReviewDrafts();});document.addEventListener('userLoggedOut',()=>{this.updateReviewFormAccess();});},setupReviewListeners:function(){const writeReviewBtn=document.getElementById('write-review-btn');if(writeReviewBtn){writeReviewBtn.addEventListener('click',(e)=>{e.preventDefault();if(this.checkAuthForReview()){this.showReviewForm();}});}const cancelReviewBtn=document.getElementById('cancel-review-btn');if(cancelReviewBtn){cancelReviewBtn.addEventListener('click',(e)=>{e.preventDefault();this.hideReviewForm();});}const reviewForm=document.querySelector('.review-form');if(reviewForm){reviewForm.addEventListener('submit',(e)=>{e.preventDefault();this.handleReviewSubmission();});}const ratingStars=document.querySelectorAll('.rating-selector .stars i');if(ratingStars.length>0){ratingStars.forEach(star=>{star.addEventListener('click',(e)=>{const rating=parseInt(e.target.getAttribute('data-rating'));this.setReviewRating(rating);});star.addEventListener('mouseover',(e)=>{const rating=parseInt(e.target.getAttribute('data-rating'));this.previewRating(rating);});});const starsContainer=document.querySelector('.rating-selector .stars');if(starsContainer){starsContainer.addEventListener('mouseleave',()=>{this.resetRatingPreview();});}}const sortSelect=document.getElementById('review-sort');if(sortSelect){sortSelect.addEventListener('change',()=>{this.state.sortBy=sortSelect.value;this.refreshReviews();});}const filterSelect=document.getElementById('review-filter');if(filterSelect){filterSelect.addEventListener('change',()=>{this.state.filterBy=filterSelect.value;this.refreshReviews();});}const mediaUpload=document.getElementById('review-media');if(mediaUpload){mediaUpload.addEventListener('change',(e)=>{this.handleMediaUpload(e.target.files);});const dropZone=document.querySelector('.media-dropzone');if(dropZone){['dragenter','dragover','dragleave','drop'].forEach(eventName=>{dropZone.addEventListener(eventName,(e)=>{e.preventDefault();e.stopPropagation();});});dropZone.addEventListener('dragenter',()=>dropZone.classList.add('highlight'));dropZone.addEventListener('dragover',()=>dropZone.classList.add('highlight'));dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('highlight'));dropZone.addEventListener('drop',(e)=>{dropZone.classList.remove('highlight');this.handleMediaUpload(e.dataTransfer.files);});}}document.addEventListener('click',(e)=>{const helpfulBtn=e.target.closest('.helpful-btn');if(helpfulBtn){e.preventDefault();const reviewId=helpfulBtn.closest('.review-item').getAttribute('data-review-id');const isHelpful=helpfulBtn.classList.contains('helpful-yes');this.voteReview(reviewId,isHelpful);return;}const reportBtn=e.target.closest('.report-review');if(reportBtn){e.preventDefault();const reviewId=reportBtn.closest('.review-item').getAttribute('data-review-id');this.reportReview(reviewId);return;}const reviewImage=e.target.closest('.review-media-item img');if(reviewImage){e.preventDefault();const mediaUrl=reviewImage.getAttribute('src');const reviewId=reviewImage.closest('.review-item').getAttribute('data-review-id');this.openMediaGallery(reviewId,mediaUrl);return;}});document.addEventListener('click',(e)=>{const paginationItem=e.target.closest('.pagination-item');if(paginationItem){e.preventDefault();if(paginationItem.classList.contains('next')){this.nextPage();}else if(paginationItem.classList.contains('prev')){this.prevPage();}else{const page=parseInt(paginationItem.textContent);if(!isNaN(page)){this.goToPage(page);}}}});},checkAuthForReview:function(){if(window.AuthManager&&typeof window.AuthManager.isAuthenticated==='function'){const isAuth=window.AuthManager.isAuthenticated();if(!isAuth){console.log('[DEBUG]review-manager.js:User not authenticated for review action');localStorage.setItem('pendingReviewProduct',this.state.currentProductId);if(window.AuthManager.showAuthModal){window.AuthManager.showAuthModal('login','Please log in to write a review');}else{window.location.href='login.html?redirect='+encodeURIComponent(window.location.href);}return false;}return true;}return true;},checkPendingReviewDrafts:function(){const pendingProductId=localStorage.getItem('pendingReviewProduct');if(pendingProductId&&pendingProductId===this.state.currentProductId){localStorage.removeItem('pendingReviewProduct');this.showReviewForm();const draftKey=`reviewDraft_${pendingProductId}`;const savedDraft=localStorage.getItem(draftKey);if(savedDraft){try{const draft=JSON.parse(savedDraft);this.restoreReviewDraft(draft);}catch(e){console.error('[DEBUG]review-manager.js:Error restoring review draft:',e);}}}},loadProductReviews:function(productId){console.log('[DEBUG]review-manager.js:Loading reviews for product:',productId);const reviewsContent=document.querySelector('#reviews .reviews-content');if(reviewsContent){reviewsContent.innerHTML=`<div class="loading-reviews"><div class="spinner"></div><p>Loading reviews...</p></div>`;}setTimeout(()=>{const allReviews=window.REVIEWS&&window.REVIEWS.getReviewsByProductId?window.REVIEWS.getReviewsByProductId(productId):[];this.state.currentReviews=allReviews;this.calculateReviewStats();this.renderReviewSummary();this.renderReviews();if(window.PRODUCTS&&window.PRODUCTS.items){const product=window.PRODUCTS.items.find(p=>p.id===productId);if(product){product.rating=this.state.reviewStats.averageRating;product.reviewCount=this.state.reviewStats.totalCount;}}console.log('[DEBUG]review-manager.js:Reviews loaded:',this.state.currentReviews.length);},500);},calculateReviewStats:function(){const reviews=this.state.currentReviews;const stats={averageRating:0,totalCount:reviews.length,distribution:{5:0,4:0,3:0,2:0,1:0}};reviews.forEach(review=>{if(review.rating>=1&&review.rating<=5){stats.distribution[review.rating]++;}});if(stats.totalCount>0){let sum=0;for(let rating=1;rating<=5;rating++){sum+=rating*stats.distribution[rating];}stats.averageRating=sum/stats.totalCount;}this.state.reviewStats=stats;},renderReviewSummary:function(){const summaryContainer=document.querySelector('.review-summary .rating-overview');if(!summaryContainer)return;const stats=this.state.reviewStats;const ratingNumber=summaryContainer.querySelector('.rating-number');if(ratingNumber){ratingNumber.textContent=stats.averageRating.toFixed(1);}const stars=summaryContainer.querySelector('.stars');if(stars){stars.innerHTML=this.generateStarsHTML(stats.averageRating);}const totalReviews=summaryContainer.querySelector('.total-reviews');if(totalReviews){totalReviews.textContent=`Based on ${stats.totalCount}review${stats.totalCount!==1?'s':''}`;}for(let rating=5;rating>=1;rating--){const ratingBar=summaryContainer.querySelector(`.rating-bar:nth-child(${6-rating})`);if(ratingBar){const progress=ratingBar.querySelector('.progress');const count=ratingBar.querySelector('.count');if(progress&&count){const percentage=stats.totalCount>0?(stats.distribution[rating]/stats.totalCount)*100:0;progress.style.width=`${percentage}%`;count.textContent=stats.distribution[rating];}}}this.checkUserReviewStatus();},renderReviews:function(){console.log('[DEBUG]review-manager.js:Re-rendering reviews');let customerReviews=document.querySelector('.customer-reviews');if(!customerReviews){console.warn('[DEBUG]review-manager.js:Customer reviews container missing-creating it');const reviewsContent=document.querySelector('.reviews-content');if(reviewsContent){customerReviews=document.createElement('div');customerReviews.className='customer-reviews';reviewsContent.appendChild(customerReviews);}}if(customerReviews){customerReviews.style.display='block';const displayReviews=this.getFilteredSortedReviews();if(displayReviews.length===0){customerReviews.innerHTML=`<div class="no-reviews"><p>No reviews match your current filters. Try a different filter or be the first to review this product!</p></div>`;return;}let reviewsHTML='';displayReviews.forEach(review=>{reviewsHTML+=this.createReviewHTML(review);});customerReviews.innerHTML=reviewsHTML;this.initReviewElements();}},getFilteredSortedReviews:function(){let reviews=[...this.state.currentReviews];switch(this.state.filterBy){case '5':case '4':case '3':case '2':case '1':const rating=parseInt(this.state.filterBy);reviews=reviews.filter(review=>review.rating===rating);break;case 'with-media':reviews=reviews.filter(review=>review.media&&review.media.length>0);break;case 'verified':reviews=reviews.filter(review=>review.verifiedPurchase);break;}switch(this.state.sortBy){case 'newest':reviews.sort((a,b)=>new Date(b.date)-new Date(a.date));break;case 'highest':reviews.sort((a,b)=>b.rating-a.rating);break;case 'lowest':reviews.sort((a,b)=>a.rating-b.rating);break;case 'most-helpful':reviews.sort((a,b)=>{const aHelpful=a.helpfulVotes?a.helpfulVotes.yes-a.helpfulVotes.no:0;const bHelpful=b.helpfulVotes?b.helpfulVotes.yes-b.helpfulVotes.no:0;return bHelpful-aHelpful;});break;case 'with-media':reviews.sort((a,b)=>{const aHasMedia=a.media&&a.media.length>0;const bHasMedia=b.media&&b.media.length>0;if(aHasMedia&&!bHasMedia)return-1;if(!aHasMedia&&bHasMedia)return 1;return new Date(b.date)-new Date(a.date);});break;}return reviews;},createReviewHTML:function(review){const reviewId=review.id;const initials=this.getNameInitials(review.authorName);const date=this.formatDate(review.date);const showVerifiedBadge=review.verifiedPurchase;const hasMedia=review.media&&review.media.length>0;const isLongContent=review.content.length>300;const truncatedContent=isLongContent?review.content.substring(0,300)+'...':review.content;const helpfulCount=review.helpfulVotes?review.helpfulVotes.yes:0;const unhelpfulCount=review.helpfulVotes?review.helpfulVotes.no:0;const userVote=this.getUserVoteForReview(reviewId);let html=`<div class="review-item" data-review-id="${reviewId}"><div class="review-header"><div class="reviewer-info"><div class="reviewer-avatar"><span>${initials}</span></div><div class="reviewer-details"><h4 class="reviewer-name">${review.authorName}</h4><div class="review-meta"><div class="stars">${this.generateStarsHTML(review.rating)}</div>${showVerifiedBadge?'<span class="verified-purchase">Verified Purchase</span>':''}<span class="review-date">${date}</span></div></div></div></div><div class="review-content"><h4 class="review-title">${review.title}</h4><div class="review-text ${isLongContent?'expandable':''}"><p class="review-text-truncated">${truncatedContent}</p>${isLongContent?`<p class="review-text-full" style="display:none;">${review.content}</p><button class="read-more-btn">Read more</button>`:''}</div>${hasMedia?this.createReviewMediaHTML(review.media):''}</div><div class="review-footer"><div class="review-helpful"><span>Was this review helpful?</span><button class="helpful-btn helpful-yes ${userVote==='yes'?'voted':''}" aria-label="Yes,this review was helpful"><i class="fas fa-thumbs-up"></i>Yes(${helpfulCount})</button><button class="helpful-btn helpful-no ${userVote==='no'?'voted':''}" aria-label="No,this review was not helpful"><i class="fas fa-thumbs-down"></i>No(${unhelpfulCount})</button></div><button class="report-review" aria-label="Report review"><i class="fas fa-flag"></i>Report</button></div></div>`;return html;},createReviewMediaHTML:function(media){if(!media||media.length===0)return '';let thumbnailsHTML='';media.forEach((item,index)=>{thumbnailsHTML+=`<div class="review-media-item"><img src="${item.url}" alt="Review image ${index+1}" loading="lazy"></div>`;});return `<div class="review-media"><h5>Customer Images(${media.length})</h5><div class="review-media-gallery">${thumbnailsHTML}</div></div>`;},createPaginationHTML:function(totalPages){const currentPage=this.state.currentPage;let paginationHTML='<div class="pagination">';if(currentPage>1){paginationHTML+='<a href="#" class="pagination-item prev"><i class="fas fa-chevron-left"></i></a>';}for(let i=1;i<=totalPages;i++){if(i<=3||i>totalPages-3||(i>=currentPage-1&&i<=currentPage+1)){paginationHTML+=`<a href="#" class="pagination-item ${i===currentPage?'active':''}">${i}</a>`;}else if(i===4&&currentPage>5||i===totalPages-3&&currentPage<totalPages-4){paginationHTML+='<span class="pagination-ellipsis">...</span>';}}if(currentPage<totalPages){paginationHTML+='<a href="#" class="pagination-item next"><i class="fas fa-chevron-right"></i></a>';}paginationHTML+='</div>';return paginationHTML;},initReviewElements:function(){const readMoreButtons=document.querySelectorAll('.read-more-btn');readMoreButtons.forEach(button=>{button.addEventListener('click',(e)=>{e.preventDefault();const reviewText=button.closest('.review-text');if(reviewText){const truncated=reviewText.querySelector('.review-text-truncated');const full=reviewText.querySelector('.review-text-full');if(truncated&&full){const isExpanded=truncated.style.display==='none';truncated.style.display=isExpanded?'block':'none';full.style.display=isExpanded?'none':'block';button.textContent=isExpanded?'Read more':'Read less';}}});});},showReviewForm:function(){const writeReviewBtn=document.getElementById('write-review-btn');const reviewFormContainer=document.querySelector('.review-form-container');if(writeReviewBtn&&reviewFormContainer){writeReviewBtn.style.display='none';reviewFormContainer.style.display='block';reviewFormContainer.scrollIntoView({behavior:'smooth',block:'start'});this.state.reviewFormVisible=true;}},hideReviewForm:function(){const writeReviewBtn=document.getElementById('write-review-btn');const reviewFormContainer=document.querySelector('.review-form-container');if(writeReviewBtn&&reviewFormContainer){writeReviewBtn.style.display='block';reviewFormContainer.style.display='none';this.state.reviewFormVisible=false;}},setReviewRating:function(rating){this.state.reviewDraft.rating=rating;const stars=document.querySelectorAll('.rating-selector .stars i');stars.forEach((star,index)=>{star.className=index<rating?'fas fa-star':'far fa-star';});const ratingText=document.querySelector('.rating-text');if(ratingText){ratingText.textContent=`${rating}${rating===1?'Star':'Stars'}`;}this.saveReviewDraft();},previewRating:function(rating){const stars=document.querySelectorAll('.rating-selector .stars i');stars.forEach((star,index)=>{star.className=index<rating?'fas fa-star':'far fa-star';});const ratingText=document.querySelector('.rating-text');if(ratingText){ratingText.textContent=`${rating}${rating===1?'Star':'Stars'}`;}},resetRatingPreview:function(){const rating=this.state.reviewDraft.rating;const stars=document.querySelectorAll('.rating-selector .stars i');stars.forEach((star,index)=>{star.className=index<rating?'fas fa-star':'far fa-star';});const ratingText=document.querySelector('.rating-text');if(ratingText){ratingText.textContent=rating>0?`${rating}${rating===1?'Star':'Stars'}`:'Click to rate';}},handleReviewSubmission:function(){console.log('[DEBUG]review-manager.js:Handling review submission');const reviewTitle=document.getElementById('review-title').value.trim();const reviewText=document.getElementById('review-text').value.trim();const rating=this.state.reviewDraft.rating;const media=this.state.reviewDraft.media;if(!rating){this.showNotification('Please select a rating','error');return;}if(!reviewTitle){this.showNotification('Please enter a review title','error');return;}if(!reviewText||reviewText.length<this.config.minReviewLength){this.showNotification(`Review must be at least ${this.config.minReviewLength}characters`,'error');return;}if(reviewText.length>this.config.maxReviewLength){this.showNotification(`Review cannot exceed ${this.config.maxReviewLength}characters`,'error');return;}const submitButton=document.querySelector('.review-form button[type="submit"]');if(submitButton){submitButton.disabled=true;submitButton.innerHTML='<i class="fas fa-spinner fa-spin"></i>Submitting...';}const reviewData={productId:this.state.currentProductId,title:reviewTitle,content:reviewText,rating:rating,media:media,date:new Date().toISOString()};setTimeout(()=>{this.handleReviewSubmissionSuccess(reviewData);const reviewForm=document.querySelector('.review-form');if(reviewForm){reviewForm.reset();}this.state.reviewDraft={rating:0,title:'',content:'',media:[]};const stars=document.querySelectorAll('.rating-selector .stars i');stars.forEach(star=>{star.className='far fa-star';});const ratingText=document.querySelector('.rating-text');if(ratingText){ratingText.textContent='Click to rate';}const mediaPreview=document.querySelector('.media-preview');if(mediaPreview){mediaPreview.innerHTML='';mediaPreview.style.display='none';}if(submitButton){submitButton.disabled=false;submitButton.innerHTML='Submit Review';}this.hideReviewForm();this.clearReviewDraft();this.showNotification('Your review has been submitted successfully!','success');this.loadProductReviews(this.state.currentProductId);},1000);},handleReviewSubmissionSuccess:function(reviewData){console.log('[DEBUG]review-manager.js:Review submitted successfully:',reviewData);this.addUserReview(reviewData);},handleMediaUpload:function(files){if(!files||files.length===0)return;const currentCount=this.state.reviewDraft.media.length;const remainingSlots=this.config.mediaUploadLimit-currentCount;if(remainingSlots<=0){this.showNotification(`Maximum ${this.config.mediaUploadLimit}media files allowed`,'error');return;}const filesToProcess=Array.from(files).slice(0,remainingSlots);const mediaPreview=document.querySelector('.media-preview');if(mediaPreview){if(currentCount===0){mediaPreview.innerHTML='<div class="media-loading"><i class="fas fa-spinner fa-spin"></i>Processing media...</div>';mediaPreview.style.display='block';}}const mediaPromises=filesToProcess.map(file=>{return new Promise((resolve,reject)=>{if(!file.type.startsWith('image/')){reject(new Error('Only image files are supported'));return;}if(file.size>5*1024*1024){reject(new Error('File size must be less than 5MB'));return;}const reader=new FileReader();reader.onload=(e)=>{resolve({url:e.target.result,name:file.name,type:file.type,size:file.size});};reader.onerror=()=>{reject(new Error('Error reading file'));};reader.readAsDataURL(file);});});Promise.allSettled(mediaPromises).then(results=>{const successfulUploads=results .filter(result=>result.status==='fulfilled').map(result=>result.value);this.state.reviewDraft.media=[...this.state.reviewDraft.media,...successfulUploads];const failedUploads=results.filter(result=>result.status==='rejected');if(failedUploads.length>0){const errorMessage=failedUploads[0].reason.message;this.showNotification(errorMessage,'error');}this.updateMediaPreview();this.saveReviewDraft();});},updateMediaPreview:function(){const mediaPreview=document.querySelector('.media-preview');if(!mediaPreview)return;const media=this.state.reviewDraft.media;if(media.length===0){mediaPreview.innerHTML='';mediaPreview.style.display='none';return;}let previewHTML='<div class="media-preview-items">';media.forEach((item,index)=>{previewHTML+=`<div class="media-preview-item"><img src="${item.url}" alt="Preview ${index+1}"><button class="remove-media" data-index="${index}" aria-label="Remove image"><i class="fas fa-times"></i></button></div>`;});previewHTML+='</div>';previewHTML+=`<div class="media-info">${media.length}of ${this.config.mediaUploadLimit}images added</div>`;mediaPreview.innerHTML=previewHTML;mediaPreview.style.display='block';const removeButtons=mediaPreview.querySelectorAll('.remove-media');removeButtons.forEach(button=>{button.addEventListener('click',(e)=>{e.preventDefault();const index=parseInt(button.getAttribute('data-index'));if(!isNaN(index)){this.removeMedia(index);}});});},removeMedia:function(index){if(index<0||index>=this.state.reviewDraft.media.length)return;this.state.reviewDraft.media.splice(index,1);this.updateMediaPreview();this.saveReviewDraft();},voteReview:function(reviewId,isHelpful){console.log(`[DEBUG]review-manager.js:Voting ${isHelpful?'helpful':'unhelpful'}for review:`,reviewId);if(!this.checkAuthForReview()){return;}const existingVote=this.getUserVoteForReview(reviewId);if((existingVote==='yes'&&isHelpful)||(existingVote==='no'&&!isHelpful)){this.removeReviewVote(reviewId);return;}if(existingVote){this.removeReviewVote(reviewId,false);}const review=this.state.currentReviews.find(r=>r.id===reviewId);if(!review){console.warn('[DEBUG]review-manager.js:Review not found for voting:',reviewId);return;}if(!review.helpfulVotes){review.helpfulVotes={yes:0,no:0};}if(isHelpful){review.helpfulVotes.yes++;}else{review.helpfulVotes.no++;}this.saveUserVote(reviewId,isHelpful?'yes':'no');this.updateReviewVotes(reviewId);},removeReviewVote:function(reviewId,updateUI=true){const existingVote=this.getUserVoteForReview(reviewId);if(!existingVote)return;const review=this.state.currentReviews.find(r=>r.id===reviewId);if(!review||!review.helpfulVotes)return;if(existingVote==='yes'){review.helpfulVotes.yes=Math.max(0,review.helpfulVotes.yes-1);}else{review.helpfulVotes.no=Math.max(0,review.helpfulVotes.no-1);}this.removeUserVoteRecord(reviewId);if(updateUI){this.updateReviewVotes(reviewId);}},updateReviewVotes:function(reviewId){const reviewElement=document.querySelector(`.review-item[data-review-id="${reviewId}"]`);if(!reviewElement)return;const review=this.state.currentReviews.find(r=>r.id===reviewId);if(!review||!review.helpfulVotes)return;const helpfulBtn=reviewElement.querySelector('.helpful-yes');const unhelpfulBtn=reviewElement.querySelector('.helpful-no');if(helpfulBtn){helpfulBtn.innerHTML=`<i class="fas fa-thumbs-up"></i>Yes(${review.helpfulVotes.yes})`;}if(unhelpfulBtn){unhelpfulBtn.innerHTML=`<i class="fas fa-thumbs-down"></i>No(${review.helpfulVotes.no})`;}const userVote=this.getUserVoteForReview(reviewId);if(helpfulBtn){helpfulBtn.classList.toggle('voted',userVote==='yes');}if(unhelpfulBtn){unhelpfulBtn.classList.toggle('voted',userVote==='no');}},reportReview:function(reviewId){console.log('[DEBUG]review-manager.js:Reporting review:',reviewId);if(!this.checkAuthForReview()){return;}this.openReportModal(reviewId);},openReportModal:function(reviewId){let reportModal=document.getElementById('report-review-modal');if(!reportModal){reportModal=document.createElement('div');reportModal.id='report-review-modal';reportModal.className='modal';reportModal.innerHTML=`<div class="modal-content"><button class="modal-close" aria-label="Close modal"><i class="fas fa-times"></i></button><div class="report-content"><h3>Report Review</h3><p>Please select a reason for reporting this review:</p><form id="report-form"><div class="form-group"><label class="radio-container"><input type="radio" name="report-reason" value="inappropriate" checked><span class="checkmark"></span><span>Inappropriate content</span></label></div><div class="form-group"><label class="radio-container"><input type="radio" name="report-reason" value="spam"><span class="checkmark"></span><span>Spam or misleading</span></label></div><div class="form-group"><label class="radio-container"><input type="radio" name="report-reason" value="not-relevant"><span class="checkmark"></span><span>Not relevant to product</span></label></div><div class="form-group"><label class="radio-container"><input type="radio" name="report-reason" value="other"><span class="checkmark"></span><span>Other</span></label></div><div class="form-group" id="other-reason-group" style="display:none;"><label for="other-reason">Please explain:</label><textarea id="other-reason" class="form-control" rows="3"></textarea></div><div class="form-buttons"><button type="button" class="btn btn-outline" id="cancel-report-btn">Cancel</button><button type="submit" class="btn btn-dark">Submit Report</button></div></form></div></div>`;document.body.appendChild(reportModal);const closeBtn=reportModal.querySelector('.modal-close');if(closeBtn){closeBtn.addEventListener('click',()=>{reportModal.classList.remove('show');document.body.style.overflow='';});}const cancelBtn=reportModal.querySelector('#cancel-report-btn');if(cancelBtn){cancelBtn.addEventListener('click',()=>{reportModal.classList.remove('show');document.body.style.overflow='';});}const reasonRadios=reportModal.querySelectorAll('input[name="report-reason"]');const otherReasonGroup=reportModal.querySelector('#other-reason-group');reasonRadios.forEach(radio=>{radio.addEventListener('change',()=>{otherReasonGroup.style.display=radio.value==='other'?'block':'none';});});const reportForm=reportModal.querySelector('#report-form');if(reportForm){reportForm.addEventListener('submit',(e)=>{e.preventDefault();const selectedReason=reportModal.querySelector('input[name="report-reason"]:checked');let reason=selectedReason?selectedReason.value:'inappropriate';if(reason==='other'){const otherReasonText=reportModal.querySelector('#other-reason').value.trim();if(!otherReasonText){this.showNotification('Please explain your reason for reporting','error');return;}reason=otherReasonText;}this.submitReviewReport(reviewId,reason);reportModal.classList.remove('show');document.body.style.overflow='';});}}reportModal.setAttribute('data-review-id',reviewId);reportModal.classList.add('show');document.body.style.overflow='hidden';},submitReviewReport:function(reviewId,reason){console.log('[DEBUG]review-manager.js:Submitting report for review:',reviewId,'Reason:',reason);this.showNotification('Your report has been submitted. Thank you for helping us maintain quality content!','success');},openMediaGallery:function(reviewId,initialImage){console.log('[DEBUG]review-manager.js:Opening media gallery for review:',reviewId);const review=this.state.currentReviews.find(r=>r.id===reviewId);if(!review||!review.media||review.media.length===0)return;let galleryModal=document.getElementById('review-media-gallery-modal');if(!galleryModal){galleryModal=document.createElement('div');galleryModal.id='review-media-gallery-modal';galleryModal.className='modal gallery-modal';galleryModal.innerHTML=`<div class="modal-content"><button class="modal-close" aria-label="Close modal"><i class="fas fa-times"></i></button><div class="gallery-content"><div class="gallery-main-image"><img src="" alt="Review image"></div><div class="gallery-controls"><button class="gallery-prev" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button><div class="gallery-counter">Image<span class="current-index">1</span>of<span class="total-images">1</span></div><button class="gallery-next" aria-label="Next image"><i class="fas fa-chevron-right"></i></button></div><div class="gallery-thumbnails"></div></div></div>`;document.body.appendChild(galleryModal);const closeBtn=galleryModal.querySelector('.modal-close');if(closeBtn){closeBtn.addEventListener('click',()=>{galleryModal.classList.remove('show');document.body.style.overflow='';});}const prevBtn=galleryModal.querySelector('.gallery-prev');const nextBtn=galleryModal.querySelector('.gallery-next');if(prevBtn){prevBtn.addEventListener('click',()=>{const currentIndex=parseInt(galleryModal.getAttribute('data-current-index')||'0');const totalImages=parseInt(galleryModal.getAttribute('data-total-images')||'0');const newIndex=(currentIndex-1+totalImages)%totalImages;this.updateGalleryImage(newIndex);});}if(nextBtn){nextBtn.addEventListener('click',()=>{const currentIndex=parseInt(galleryModal.getAttribute('data-current-index')||'0');const totalImages=parseInt(galleryModal.getAttribute('data-total-images')||'0');const newIndex=(currentIndex+1)%totalImages;this.updateGalleryImage(newIndex);});}document.addEventListener('keydown',(e)=>{if(!galleryModal.classList.contains('show'))return;if(e.key==='Escape'){galleryModal.classList.remove('show');document.body.style.overflow='';}else if(e.key==='ArrowLeft'){prevBtn.click();}else if(e.key==='ArrowRight'){nextBtn.click();}});}galleryModal.setAttribute('data-review-id',reviewId);galleryModal.setAttribute('data-media',JSON.stringify(review.media));const thumbnailsContainer=galleryModal.querySelector('.gallery-thumbnails');if(thumbnailsContainer){let thumbnailsHTML='';review.media.forEach((item,index)=>{thumbnailsHTML+=`<div class="gallery-thumbnail" data-index="${index}"><img src="${item.url}" alt="Thumbnail ${index+1}"></div>`;});thumbnailsContainer.innerHTML=thumbnailsHTML;const thumbnails=thumbnailsContainer.querySelectorAll('.gallery-thumbnail');thumbnails.forEach(thumbnail=>{thumbnail.addEventListener('click',()=>{const index=parseInt(thumbnail.getAttribute('data-index')||'0');this.updateGalleryImage(index);});});}const totalImagesEl=galleryModal.querySelector('.total-images');if(totalImagesEl){totalImagesEl.textContent=review.media.length;}let initialIndex=0;if(initialImage){const index=review.media.findIndex(item=>item.url===initialImage);if(index!==-1){initialIndex=index;}}galleryModal.setAttribute('data-total-images',review.media.length.toString());galleryModal.setAttribute('data-current-index',initialIndex.toString());this.updateGalleryImage(initialIndex);galleryModal.classList.add('show');document.body.style.overflow='hidden';},updateGalleryImage:function(index){const galleryModal=document.getElementById('review-media-gallery-modal');if(!galleryModal)return;const mediaJSON=galleryModal.getAttribute('data-media');if(!mediaJSON)return;try{const media=JSON.parse(mediaJSON);if(!media||!Array.isArray(media)||index>=media.length)return;const mainImage=galleryModal.querySelector('.gallery-main-image img');if(mainImage){mainImage.src=media[index].url;}galleryModal.setAttribute('data-current-index',index.toString());const currentIndexEl=galleryModal.querySelector('.current-index');if(currentIndexEl){currentIndexEl.textContent=(index+1).toString();}const thumbnails=galleryModal.querySelectorAll('.gallery-thumbnail');thumbnails.forEach((thumbnail,i)=>{thumbnail.classList.toggle('active',i===index);});}catch(e){console.error('[DEBUG]review-manager.js:Error parsing media JSON:',e);}},checkUserReviewStatus:function(){if(!this.state.currentProductId)return;const hasReviewed=this.hasUserReviewedProduct(this.state.currentProductId);const writeReviewBtn=document.getElementById('write-review-btn');if(writeReviewBtn){if(hasReviewed){writeReviewBtn.textContent='Edit Your Review';writeReviewBtn.setAttribute('data-action','edit');}else{writeReviewBtn.textContent='Write a Review';writeReviewBtn.setAttribute('data-action','create');}}},nextPage:function(){const displayReviews=this.getFilteredSortedReviews();const totalPages=Math.ceil(displayReviews.length/this.config.defaultPageSize);if(this.state.currentPage<totalPages){this.state.currentPage++;this.renderReviews();const reviewsContainer=document.querySelector('.customer-reviews');if(reviewsContainer){reviewsContainer.scrollIntoView({behavior:'smooth',block:'start'});}}},prevPage:function(){if(this.state.currentPage>1){this.state.currentPage--;this.renderReviews();const reviewsContainer=document.querySelector('.customer-reviews');if(reviewsContainer){reviewsContainer.scrollIntoView({behavior:'smooth',block:'start'});}}},goToPage:function(page){const displayReviews=this.getFilteredSortedReviews();const totalPages=Math.ceil(displayReviews.length/this.config.defaultPageSize);if(page>=1&&page<=totalPages){this.state.currentPage=page;this.renderReviews();const reviewsContainer=document.querySelector('.customer-reviews');if(reviewsContainer){reviewsContainer.scrollIntoView({behavior:'smooth',block:'start'});}}},refreshReviews:function(){this.state.currentPage=1;this.renderReviews();},saveReviewDraft:function(){if(!this.state.currentProductId)return;const draftKey=`reviewDraft_${this.state.currentProductId}`;try{localStorage.setItem(draftKey,JSON.stringify(this.state.reviewDraft));}catch(e){console.error('[DEBUG]review-manager.js:Error saving review draft:',e);}},clearReviewDraft:function(){if(!this.state.currentProductId)return;const draftKey=`reviewDraft_${this.state.currentProductId}`;try{localStorage.removeItem(draftKey);}catch(e){console.error('[DEBUG]review-manager.js:Error clearing review draft:',e);}},restoreReviewDraft:function(draft){this.state.reviewDraft=draft;const reviewTitle=document.getElementById('review-title');const reviewText=document.getElementById('review-text');if(reviewTitle&&draft.title){reviewTitle.value=draft.title;}if(reviewText&&draft.content){reviewText.value=draft.content;}if(draft.rating){this.setReviewRating(draft.rating);}if(draft.media&&draft.media.length>0){this.updateMediaPreview();}},addUserReview:function(reviewData){if(!reviewData.productId)return;const reviewId=`review_${Date.now()}`;const userInfo=this.getUserInfo();const review={id:reviewId,...reviewData,authorId:userInfo.id,authorName:userInfo.name,verifiedPurchase:true,helpfulVotes:{yes:0,no:0}};this.state.userReviews[reviewData.productId]=review;this.saveUserReviewData();},hasUserReviewedProduct:function(productId){return!!this.state.userReviews[productId];},saveUserVote:function(reviewId,vote){if(!reviewId||!vote)return;this.state.reviewVotes[reviewId]=vote;this.saveUserReviewData();},removeUserVoteRecord:function(reviewId){if(!reviewId||!this.state.reviewVotes[reviewId])return;delete this.state.reviewVotes[reviewId];this.saveUserReviewData();},getUserVoteForReview:function(reviewId){return this.state.reviewVotes[reviewId]||null;},saveUserReviewData:function(){try{localStorage.setItem('bingoUserReviews',JSON.stringify(this.state.userReviews));localStorage.setItem('bingoUserReviewVotes',JSON.stringify(this.state.reviewVotes));}catch(e){console.error('[DEBUG]review-manager.js:Error saving user review data:',e);}},loadUserReviewData:function(){try{const savedReviews=localStorage.getItem('bingoUserReviews');const savedVotes=localStorage.getItem('bingoUserReviewVotes');if(savedReviews){this.state.userReviews=JSON.parse(savedReviews);}if(savedVotes){this.state.reviewVotes=JSON.parse(savedVotes);}}catch(e){console.error('[DEBUG]review-manager.js:Error loading user review data:',e);this.state.userReviews={};this.state.reviewVotes={};}},refreshReviews:function(){console.log('[DEBUG]review-manager.js:Refreshing reviews');if(this.state.currentProductId){const currentSort=this.state.sortBy;const currentFilter=this.state.filterBy;this.loadProductReviews(this.state.currentProductId);}},getUserInfo:function(){const defaultInfo={id:'user_123',name:'John Doe'};if(window.AuthManager&&typeof window.AuthManager.getUserInfo==='function'){const authUserInfo=window.AuthManager.getUserInfo();if(authUserInfo){return authUserInfo;}}return defaultInfo;},getNameInitials:function(name){if(!name)return '??';const nameParts=name.split(' ');if(nameParts.length===1){return name.substring(0,2).toUpperCase();}return(nameParts[0].charAt(0)+nameParts[nameParts.length-1].charAt(0)).toUpperCase();},formatDate:function(dateString){const date=new Date(dateString);if(isNaN(date.getTime())){return 'Invalid date';}const options={year:'numeric',month:'long',day:'numeric'};return date.toLocaleDateString('en-US',options);},generateStarsHTML:function(rating){if(typeof rating!=='number'||isNaN(rating)){return '<i class="far fa-star"></i>'.repeat(5);}const fullStars=Math.floor(rating);const hasHalfStar=rating%1>=0.5;let html='';for(let i=0;i<5;i++){if(i<fullStars){html+='<i class="fas fa-star"></i>';}else if(i===fullStars&&hasHalfStar){html+='<i class="fas fa-star-half-alt"></i>';}else{html+='<i class="far fa-star"></i>';}}return html;},isProductPage:function(){return(window.location.pathname.includes('product.html')||document.querySelector('.product-detail')!==null);},showNotification:function(message,type='success'){console.log(`[DEBUG]review-manager.js:Showing notification-Type:${type},Message:${message}`);if(window.CartManager&&typeof window.CartManager.showNotification==='function'){window.CartManager.showNotification(message,type);return;}const notificationContainer=document.getElementById('notification-container')||this.createNotificationContainer();const notification=document.createElement('div');notification.className=`notification ${type}`;notification.innerHTML=`<div class="notification-content"><i class="${type==='success'?'fas fa-check-circle':'fas fa-exclamation-circle'}"></i><p>${message}</p></div><button class="notification-close"><i class="fas fa-times"></i></button>`;notificationContainer.appendChild(notification);setTimeout(()=>{notification.classList.add('show');},10);const closeBtn=notification.querySelector('.notification-close');let autoCloseTimeoutId=setTimeout(()=>closeNotification(notification),3000);closeBtn.addEventListener('click',()=>closeNotification(notification,autoCloseTimeoutId),{once:true});function closeNotification(notif,timeoutIdToClear=null){if(timeoutIdToClear)clearTimeout(timeoutIdToClear);if(!notif||!notif.parentNode)return;notif.classList.remove('show');notif.classList.add('hide');notif.addEventListener('transitionend',()=>{if(notif.parentNode){notif.parentNode.removeChild(notif);}},{once:true});}},createNotificationContainer:function(){let container=document.getElementById('notification-container');if(!container){container=document.createElement('div');container.id='notification-container';document.body.appendChild(container);console.log('[DEBUG]review-manager.js:Notification container created.');}return container;}};if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){if(window.ReviewManager){window.ReviewManager.init();}});}else{if(window.ReviewManager){window.ReviewManager.init();}}console.log('[DEBUG]review-manager.js:ReviewManager object defined');